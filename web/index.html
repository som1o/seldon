<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; img-src 'self' data: blob: http: https:; connect-src 'self' ws: wss:; font-src 'self' data: https://fonts.gstatic.com;" />
  <title>Seldon // Analytics Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
  <style>
    /* ── LAYERED OBSIDIAN DESIGN SYSTEM ─────────────────────────────────── */
    :root {
      /* depth layers */
      --c-bg:        #07080d;
      --c-surface:   #0d1018;
      --c-panel:     #111520;
      --c-raised:    #181d2a;
      /* borders — 1px semi-transparent, no heavy chrome */
      --c-border:    rgba(255,255,255,0.07);
      --c-border-hi: rgba(255,255,255,0.13);
      --c-line:      rgba(255,255,255,0.10);
      /* typography */
      --c-text:      #c4cad6;
      --c-muted:     #454e5e;
      --c-dim:       #6b7485;
      /* ── PRIMARY ACCENT: ember amber ── tactical, mission-critical */
      --c-cyan:      #e8940a;   /* primary glow / CTA  */
      --c-cyan-dk:   #b97208;   /* button fill         */
      /* state signal palette */
      --c-red:       #cc3333;
      --c-green:     #1a9e5a;
      --c-amber:     #d4820a;   /* WS connecting       */
      /* glow radii */
      --g-amber:     rgba(232,148,10,0.45);
      --g-ice:       rgba(100,180,255,0.30);
      --g-red:       rgba(204,51,51,0.40);
      --g-green:     rgba(26,158,90,0.40);
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }

    body {
      background: var(--c-bg);
      color: var(--c-text);
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 14px;
      line-height: 1.5;
    }

    /* ── SCROLLBARS ─────────────────────────────────────────────────────── */
    * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent; }
    *::-webkit-scrollbar { width: 3px; height: 3px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); }

    /* ── TYPOGRAPHY ─────────────────────────────────────────────────────── */
    .sec-label {
      font-size: 11px; font-weight: 700;
      letter-spacing: .12em; text-transform: uppercase;
      color: var(--c-muted);
    }
    /* JetBrains Mono — raw data, identifiers, live output */
    .mono { font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; }

    /* ── FIELDS ─────────────────────────────────────────────────────────── */
    .field {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--c-border);
      color: var(--c-text);
      padding: 6px 10px;
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: border-color .12s, box-shadow .12s;
      border-radius: 0;
    }
    .field:focus {
      border-color: var(--c-cyan-dk);
      box-shadow: 0 0 0 1px rgba(232,148,10,0.20) inset;
    }
    .field::placeholder { color: var(--c-muted); }
    select.field option { background: var(--c-panel); color: var(--c-text); }

    /* ── BUTTONS ────────────────────────────────────────────────────────── */
    .btn {
      padding: 7px 14px;
      font-family: 'Inter', sans-serif;
      font-size: 12px; font-weight: 600;
      letter-spacing: .07em; text-transform: uppercase;
      border: 1px solid transparent;
      border-radius: 0;
      cursor: pointer;
      transition: background .12s, border-color .12s, color .12s, box-shadow .12s;
      white-space: nowrap; min-height: 32px;
    }
    .btn:disabled { opacity: .35; cursor: not-allowed; }

    /* primary — ember amber, mission-critical action */
    .btn-primary {
      background: rgba(185,114,8,0.20);
      border-color: rgba(232,148,10,0.50);
      color: #e8940a;
    }
    .btn-primary:not(:disabled):hover {
      background: rgba(232,148,10,0.18);
      border-color: var(--c-cyan);
      color: #f5a520;
      box-shadow: 0 0 8px var(--g-amber);
    }

    /* secondary — ghost steel */
    .btn-secondary {
      background: rgba(255,255,255,0.03);
      border-color: var(--c-border);
      color: var(--c-dim);
    }
    .btn-secondary:not(:disabled):hover {
      border-color: var(--c-border-hi);
      color: var(--c-text);
    }

    /* danger — threat red */
    .btn-danger {
      background: rgba(204,51,51,0.10);
      border-color: rgba(204,51,51,0.35);
      color: #cc4444;
    }
    .btn-danger:not(:disabled):hover {
      background: rgba(204,51,51,0.18);
      border-color: var(--c-red);
      box-shadow: 0 0 7px var(--g-red);
    }

    /* success — operative green */
    .btn-success {
      background: rgba(26,158,90,0.10);
      border-color: rgba(26,158,90,0.35);
      color: #1fa864;
    }
    .btn-success:not(:disabled):hover {
      background: rgba(26,158,90,0.18);
      border-color: var(--c-green);
      box-shadow: 0 0 7px var(--g-green);
    }

    /* ── PROGRESS ───────────────────────────────────────────────────────── */
    #progressTrack { height: 1px; background: var(--c-border); width: 100%; }
    #progressBar {
      height: 1px; background: var(--c-cyan);
      transition: width .25s ease;
      box-shadow: 0 0 5px 1px var(--g-amber);
    }

    /* ── REPORT BADGES ──────────────────────────────────────────────────── */
    .report-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 10px; border: 1px solid var(--c-border);
      background: transparent; font-size: 11px; font-weight: 700;
      letter-spacing: .08em; text-transform: uppercase; color: var(--c-muted);
      white-space: nowrap;
    }
    .report-badge.has-content {
      border-color: rgba(232,148,10,0.35);
      color: var(--c-cyan);
      background: rgba(232,148,10,0.06);
    }
    .report-badge .dot {
      width: 4px; height: 4px;
      background: var(--c-muted); flex-shrink: 0;
      /* square dot — tactical */
    }
    .report-badge.has-content .dot {
      background: var(--c-cyan);
      box-shadow: 0 0 4px var(--g-amber);
    }

    /* ── STATUS DOT ─────────────────────────────────────────────────────── */
    .status-dot {
      display: inline-block; width: 5px; height: 5px;
      flex-shrink: 0;
      /* square — not rounded; mission-critical aesthetic */
    }

    /* WS glow animation — active state luminosity signal */
    @keyframes ws-alive {
      0%,100% { box-shadow: 0 0 3px 0 currentColor; }
      50%      { box-shadow: 0 0 8px 2px currentColor; }
    }
    .ws-live { animation: ws-alive 2.4s ease-in-out infinite; }

    /* ── DATA TABLES ────────────────────────────────────────────────────── */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th, .data-table td {
      padding: 5px 10px;
      border-bottom: 1px solid var(--c-border);
      border-right: 1px solid var(--c-border);
      text-align: left;
    }
    .data-table th {
      color: var(--c-muted); font-weight: 700; font-size: 11px;
      letter-spacing: .09em; text-transform: uppercase;
      background: rgba(255,255,255,0.02);
    }
    .data-table tr:hover td { background: rgba(255,255,255,0.025); }

    /* ── DIVIDER ────────────────────────────────────────────────────────── */
    .h-divider { border: none; border-top: 1px solid var(--c-border); margin: 0; }

    /* ── FILE INPUT ─────────────────────────────────────────────────────── */
    input[type="file"] { color: var(--c-dim); font-size: 13px; }
    input[type="file"]::file-selector-button {
      background: rgba(255,255,255,0.04); border: 1px solid var(--c-border);
      color: var(--c-dim); padding: 5px 11px; margin-right: 8px;
      cursor: pointer; font-size: 12px; font-family: 'Inter', sans-serif;
      border-radius: 0;
    }
    input[type="file"]::file-selector-button:hover {
      border-color: rgba(232,148,10,0.40); color: var(--c-cyan);
    }

    /* ── SPINNER ────────────────────────────────────────────────────────── */
    .spin {
      display: inline-block; width: 11px; height: 11px;
      border: 1.5px solid rgba(255,255,255,0.10); border-top-color: var(--c-cyan);
      border-radius: 50%; animation: rotation .55s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes rotation { to { transform: rotate(360deg); } }

    /* ── OPEN FULL ANALYSIS CTA ────────────────────────────────────────── */
    #openFullAnalysisBtn {
      border-color: rgba(232,148,10,0.65);
      background: rgba(185,114,8,0.20);
    }
    #openFullAnalysisBtn:not(:disabled):hover {
      background: rgba(232,148,10,0.22);
      border-color: #e8940a;
      box-shadow: 0 0 20px 2px rgba(232,148,10,0.28), inset 0 0 12px rgba(232,148,10,0.06);
      color: #f5a520;
    }

    /* ── HEADER GLASS ───────────────────────────────────────────────────── */
    .layer-glass {
      background: rgba(10,12,20,0.82);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
  </style>
</head>
<body>

  <!-- Toast container -->
  <div id="toastContainer" class="fixed top-3 right-3 z-50 flex flex-col gap-2"
       style="pointer-events:none;" aria-live="polite" aria-atomic="true"></div>

  <div style="display:grid; grid-template-rows:36px 1fr; height:100vh; overflow:hidden;">

    <!-- HEADER -->
    <header class="layer-glass"
            style="border-bottom:1px solid var(--c-border);
                   padding:0 14px; display:flex; align-items:center;
                   justify-content:space-between; gap:16px; min-height:36px;
                   position:relative; z-index:10;">
      <div style="display:flex; align-items:baseline; gap:8px;">
        <span style="font-size:15px; font-weight:700; letter-spacing:.22em;
                     text-transform:uppercase; color:var(--c-cyan);
                     text-shadow:0 0 12px var(--g-amber);">Seldon</span>
        <span style="font-size:11px; letter-spacing:.18em; text-transform:uppercase;
                     color:var(--c-muted); font-weight:600; padding-left:2px;
                     border-left:1px solid var(--c-border); padding-left:7px;">Analytics Dashboard</span>
      </div>
      <div id="wsStatusWrap" style="display:flex; align-items:center; gap:6px;
                                    font-size:11px; font-weight:600; letter-spacing:.06em;
                                    text-transform:uppercase; color:var(--c-dim);">
        <span id="wsStatusDot" class="status-dot" style="background:var(--c-amber);" aria-hidden="true"></span>
        <span id="wsStatus" class="mono" style="font-size:11px;" aria-live="polite">WS: Connecting</span>
      </div>
    </header>

    <!-- MAIN GRID -->
    <main style="display:grid; grid-template-columns:380px 1fr; overflow:hidden;"
          aria-label="Workspace and analysis launch">

      <!-- LEFT COLUMN -->
      <aside style="border-right:1px solid var(--c-border); display:flex;
                    flex-direction:column; overflow-y:auto; overflow-x:hidden;
                    background:rgba(255,255,255,0.012);">

        <!-- Workspace -->
        <section style="padding:8px 10px; border-bottom:1px solid var(--c-border);">
          <div class="sec-label" style="margin-bottom:6px;">Workspace</div>

          <div style="display:flex; gap:4px; margin-bottom:4px;">
            <input id="workspaceName" class="field" placeholder="Workspace name" style="flex:1; padding:5px 9px; font-size:12px;" />
            <button id="createWorkspaceBtn" class="btn btn-primary" style="padding:5px 10px;">Create</button>
          </div>
          <p id="workspaceError" class="hidden"
             style="font-size:13px; color:var(--c-red); margin-bottom:3px;" role="alert"></p>

          <div style="display:flex; gap:4px; margin-bottom:6px;">
            <select id="workspaceSelect" class="field" aria-label="Select workspace" style="flex:1; padding:5px 9px; font-size:12px;"></select>
            <button id="deleteWorkspaceBtn" class="btn btn-danger" style="padding:5px 10px;">Delete</button>
          </div>

          <div class="sec-label" style="margin-bottom:2px;">Notes</div>
          <textarea id="workspaceNotes" rows="2" class="field"
                    placeholder="Markdown notes" style="resize:vertical; font-size:12px; padding:5px 9px; font-family:'JetBrains Mono',monospace;"></textarea>
          <button id="saveWorkspaceNotesBtn" class="btn btn-secondary"
                  style="width:100%; margin-top:4px; padding:4px 10px;">Save Notes</button>
        </section>

        <!-- Launch Analysis -->
        <section style="padding:8px 10px; flex:1;">
          <div class="sec-label" style="margin-bottom:6px;">Launch Analysis</div>
          <form id="uploadForm">
            <div style="display:flex; flex-direction:column; gap:6px;">

              <div>
                <div class="sec-label" style="margin-bottom:2px;">Dataset File</div>
                <input type="file" id="datasetFile" required
                       accept=".csv,.tsv,.txt,.xlsx,.xls,.gz,.zip"
                       aria-describedby="datasetFileError"
                       style="width:100%; padding:3px 0; font-size:12px;" />
                <p id="datasetFileError" class="hidden"
                   style="font-size:12px; color:var(--c-red); margin-top:1px;" role="alert"></p>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px;">
                <div>
                  <div class="sec-label" style="margin-bottom:2px;">Analysis Name</div>
                  <input id="analysisName" class="field" placeholder="Model run" style="padding:5px 9px; font-size:12px;" />
                </div>
                <div>
                  <div class="sec-label" style="margin-bottom:2px;">Target Column</div>
                  <input id="targetColumn" class="field" placeholder="target"
                         aria-describedby="targetColumnError" style="padding:5px 9px; font-size:12px;" />
                  <p id="targetColumnError" class="hidden"
                     style="font-size:12px; color:var(--c-red); margin-top:1px;" role="alert"></p>
                </div>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:4px;">
                <div>
                  <div class="sec-label" style="margin-bottom:2px;">Feature</div>
                  <select id="featureStrategy" class="field" style="padding:5px 9px; font-size:12px;">
                    <option>auto</option><option>adaptive</option>
                    <option>aggressive</option><option>lenient</option>
                  </select>
                </div>
                <div>
                  <div class="sec-label" style="margin-bottom:2px;">Neural</div>
                  <select id="neuralStrategy" class="field" style="padding:5px 9px; font-size:12px;">
                    <option>auto</option><option>fast</option>
                    <option>balanced</option><option>expressive</option>
                  </select>
                </div>
                <div>
                  <div class="sec-label" style="margin-bottom:2px;">Bivariate</div>
                  <select id="bivariateStrategy" class="field" style="padding:5px 9px; font-size:12px;">
                    <option>auto</option><option>balanced</option>
                    <option>corr_heavy</option><option>importance_heavy</option>
                  </select>
                </div>
              </div>

              <div>
                <div class="sec-label" style="margin-bottom:2px;">Plots</div>
                <input id="plots" class="field mono" value="bivariate,univariate,overall" style="padding:5px 9px; font-size:12px;" />
              </div>

              <div>
                <button id="uploadRunBtn" class="btn btn-primary" type="submit"
                        style="width:100%; padding:8px 12px; font-size:12px; letter-spacing:.08em;">
                  &#9654;&nbsp; Analyze Dataset
                </button>
                <p id="uploadFormError" class="hidden"
                   style="font-size:12px; color:var(--c-red); margin-top:3px;" role="alert"></p>
              </div>

            </div>
          </form>

          <div style="margin-top:8px;">
            <div class="sec-label" style="margin-bottom:2px;">Dataset Preview</div>
            <div id="datasetPreviewContainer"
                 style="overflow-x:auto; border:1px solid var(--c-border);
                        background:rgba(255,255,255,0.02); padding:3px; min-height:20px; font-size:11px;"></div>
          </div>
        </section>

      </aside>

      <!-- RIGHT COLUMN -->
      <div style="display:grid; grid-template-rows:auto 1fr; overflow:hidden;">

        <!-- TOP: Analyses + Progress -->
        <section style="display:grid; grid-template-columns:55% 45%;
                         border-bottom:1px solid var(--c-border); overflow:hidden; max-height:200px;"
                 aria-label="Analysis monitoring">

          <!-- Analyses table -->
          <article style="border-right:1px solid var(--c-border); display:flex;
                          flex-direction:column; overflow:hidden; padding:8px 10px;">
            <div class="sec-label" style="margin-bottom:5px;">Active Analyses</div>
            <div style="overflow-y:auto; flex:1;">
              <table class="data-table" style="font-size:12px;">
                <thead>
                  <tr>
                    <th style="padding:3px 8px;">ID</th>
                    <th style="padding:3px 8px;">Status</th>
                    <th style="padding:3px 8px;">Step</th>
                    <th style="border-right:none; padding:3px 6px;"></th>
                  </tr>
                </thead>
                <tbody id="analysisRows" aria-live="polite"></tbody>
              </table>
            </div>
          </article>

          <!-- Live progress -->
          <article style="display:flex; flex-direction:column; overflow:hidden;
                          padding:8px 10px; gap:6px; justify-content:flex-start;">
            <div>
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                <div class="sec-label">Live Progress</div>
                <div id="wsLiveIndicator" class="mono" style="font-size:10px; color:var(--c-muted); letter-spacing:.06em;">IDLE</div>
              </div>
              <div id="progressTrack"><div id="progressBar" style="width:0%;"></div></div>
              <div id="progressText" class="mono"
                   style="font-size:11px; color:var(--c-dim); margin-top:5px; line-height:1.55;" aria-live="polite">
                No active analysis selected.
              </div>
            </div>

            <hr class="h-divider" style="margin-top:2px;" />

            <!-- Quick-select hint -->
            <div class="mono" style="font-size:11px; color:var(--c-muted); line-height:1.6;">
              // Click a row to inspect<br>
              // Use Export to bundle results<br>
              // Open Full Analysis for charts
            </div>
          </article>
        </section>

        <!-- BOTTOM: Analysis Summary -->
        <section style="display:flex; flex-direction:column; overflow:hidden; padding:10px 12px; gap:0;"
                 aria-label="Analysis summary">

          <!-- Header row -->
          <div style="display:flex; align-items:center; justify-content:space-between;
                      margin-bottom:7px; flex-shrink:0;">
            <h2 id="resultsHeading"
                style="font-size:11px; font-weight:700; letter-spacing:.14em;
                       text-transform:uppercase; color:var(--c-muted); margin:0;"
                tabindex="-1">Analysis Summary</h2>
          </div>

          <!-- Stat cards: univariate / bivariate / overall / reports -->
          <div id="resultStats"
               style="display:grid; grid-template-columns:repeat(4,1fr); gap:1px;
                      border:1px solid var(--c-border); flex-shrink:0;"
               role="list" aria-label="Analysis statistics"></div>

          <!-- Available report badges -->
          <div style="flex-shrink:0; margin-top:8px;">
            <div class="sec-label" style="margin-bottom:4px;">Available Reports</div>
            <div id="analysisReportList" style="display:flex; flex-wrap:wrap; gap:3px;"></div>
          </div>

          <!-- Empty / hint state -->
          <div id="analysisSummaryEmpty" class="mono"
               style="font-size:11px; color:var(--c-muted); padding:5px 0; flex-shrink:0;">
            // Select or run an analysis to see summary.
          </div>

          <hr class="h-divider" style="flex-shrink:0; margin-top:8px; margin-bottom:8px;" />

          <!-- Analysis Notes -->
          <div class="sec-label" style="margin-bottom:3px; flex-shrink:0;">Analysis Notes</div>
          <textarea id="analysisNotes" class="field"
                    placeholder="Markdown notes for selected analysis"
                    style="flex:1; resize:none; font-size:12px; padding:6px 9px;
                           font-family:'JetBrains Mono',monospace; min-height:64px;"></textarea>

          <!-- Share controls -->
          <div style="display:flex; gap:4px; margin-top:5px; flex-shrink:0;">
            <button id="saveAnalysisNotesBtn" class="btn btn-secondary"
                    style="padding:5px 10px; flex:1;">Save Notes</button>
            <button id="shareAnalysisBtn" class="btn btn-secondary"
                    style="padding:5px 10px; flex:1;">Share</button>
            <button id="copyShareLinkBtn" class="btn btn-secondary"
                    aria-label="Copy share link" style="padding:5px 10px; flex:1;">Copy Link</button>
          </div>
          <input id="shareLink" class="field mono" readonly aria-label="Share link"
                 style="font-size:11px; padding:4px 9px; margin-top:4px; flex-shrink:0;" />
          <div id="copyHint" class="hidden mono"
               style="font-size:11px; color:var(--c-green); margin-top:2px; flex-shrink:0;" role="status">// Copied</div>

          <!-- Primary CTA: Open Full Analysis -->
          <button id="openFullAnalysisBtn" class="btn btn-primary"
                  style="width:100%; margin-top:8px; padding:11px 14px;
                         font-size:13px; font-weight:700; letter-spacing:.10em;
                         flex-shrink:0;"
                  disabled>&#8599;&ensp;Open Full Analysis</button>

        </section>

      </div>
    </main>

    <!-- Hidden containers preserved for JS compatibility -->
    <div aria-hidden="true" style="display:none;">
      <div id="tablesContainer"></div>
      <div id="chartsContainer"></div>
      <h3 id="reportTitle"></h3>
      <div id="reportSwitches"></div>
      <pre id="reportMarkdown"></pre>
    </div>
  </div>

  <script type="module" src="/app.js"></script>
</body>
</html>
